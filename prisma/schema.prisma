
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserStatus {
  INACTIVE // Conta criada mas não ativada (sem depósito inicial)
  ACTIVE   // Conta ativada (depósito >= 100 EUR realizado)
  BLOCKED  // Conta bloqueada por admin
}

enum DepositAddressStatus {
  ACTIVE   // Endereço ativo e recebendo depósitos
  INACTIVE // Endereço desativado (admin)
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  SENT_TO_GLOBAL
  FAILED
}

enum WithdrawalStatus {
  PENDING_APPROVAL
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
}

enum NotificationType {
  WITHDRAWAL_APPROVED
  WITHDRAWAL_REJECTED
  WITHDRAWAL_COMPLETED
  WITHDRAWAL_FAILED
}

// ===== MLM v1.0 Enums =====

enum MLMRank {
  RECRUIT // Recruta
  BRONZE  // Bronze
  SILVER  // Prata
  GOLD    // Ouro
}

enum RankStatus {
  ACTIVE              // Rank ativo, requisitos cumpridos
  WARNING             // Mês 1: Aviso (grace period 7 dias)
  TEMPORARY_DOWNRANK  // Mês 2: Downrank temporário -1
  DOWNRANKED          // Mês 3: Downrank permanente -2
}

enum LoyaltyTier {
  NORMAL    // < 30 dias sem sacar
  FAITHFUL  // 30-90 dias (Fiel)
  LOYAL     // 90-180 dias (Leal)
  VETERAN   // 180+ dias (Veterano)
}

enum CommissionStatus {
  PENDING   // Comissão calculada mas não paga
  PAID      // Comissão paga ao usuário
  CANCELLED // Comissão cancelada (ex: usuário bloqueado)
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  name          String
  emailVerified Boolean    @default(false)
  image         String?
  role          String     @default("user") // "user" ou "admin"
  status        UserStatus @default(INACTIVE) // Inicia INATIVA até depósito de 100 EUR
  activatedAt   DateTime?  // Data de ativação da conta
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // ===== MLM v1.0 Fields =====

  // Rank Management
  currentRank       MLMRank    @default(RECRUIT)
  rankStatus        RankStatus @default(ACTIVE)
  rankConqueredAt   DateTime?  // Data que conquistou o rank atual

  // Downrank System (3 months)
  warningCount      Int        @default(0) // 0, 1, 2, 3
  originalRank      MLMRank?   // Rank original antes do downrank temporário
  gracePeriodEndsAt DateTime?  // Fim do grace period de 7 dias (WARNING status)

  // Network Stats (cached for performance)
  totalDirects   Int     @default(0) // Total lifetime de diretos (nunca diminui)
  lifetimeVolume Decimal @default(0) @db.Decimal(20, 2) // Volume total da rede (nunca diminui)

  // Blocked Balance (requisito de rank)
  blockedBalance Decimal @default(0) @db.Decimal(20, 2) // Saldo que deve manter bloqueado

  // Withdrawal Tracking
  lastWithdrawalAt   DateTime?   // Última data de saque
  withdrawalCount30d Int         @default(0) // Contador de saques nos últimos 30 dias
  loyaltyTier        LoyaltyTier @default(NORMAL) // Tier de lealdade (desconto em taxas)

  // MLM Network (referral tree)
  referrerId String? // ID do usuário que convidou
  referrer   User?   @relation("MLMNetwork", fields: [referrerId], references: [id])
  referrals  User[]  @relation("MLMNetwork") // Usuários diretos (N1)

  // Better Auth relations
  sessions Session[]
  accounts Account[]

  // App relations
  depositAddresses        DepositAddress[]
  transactions            WalletTransaction[]
  balances                Balance[]
  withdrawals             Withdrawal[]
  withdrawalNotifications WithdrawalNotification[]

  // MLM relations
  commissions  Commission[]
  monthlyStats MonthlyStats[]

  @@index([referrerId])
  @@index([currentRank])
  @@index([rankStatus])
  @@map("users")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model DepositAddress {
  id             String                @id @default(uuid())
  userId         String                @unique // 1 endereço por usuário
  polygonAddress String                @unique
  privateKey     String // Encrypted (apenas plataforma tem acesso)
  status         DepositAddressStatus  @default(ACTIVE)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@map("deposit_addresses")
}

model WalletTransaction {
  id               String            @id @default(uuid())
  userId           String
  depositAddressId String
  type             TransactionType
  tokenSymbol      String // "USDC", "MATIC", "USDT", etc
  tokenAddress     String? // Contract address (null para MATIC)
  tokenDecimals    Int // 6 para USDC, 18 para MATIC
  amount           Decimal           @db.Decimal(20, 8) // Valor já convertido com decimais
  rawAmount        String // Valor raw da blockchain
  txHash           String            @unique // Hash da transação de depósito
  transferTxHash   String?           @unique // Hash da transferência para global
  status           TransactionStatus @default(PENDING)
  createdAt        DateTime          @default(now())

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  depositAddress DepositAddress @relation(fields: [depositAddressId], references: [id], onDelete: Cascade)

  @@map("wallet_transactions")
}

model Balance {
  id               String   @id @default(uuid())
  userId           String
  tokenSymbol      String // "USDC", "MATIC", "USDT", etc
  tokenAddress     String? // Contract address (null para MATIC)
  availableBalance Decimal  @db.Decimal(20, 8) // Saldo disponível para saque
  lockedBalance    Decimal  @db.Decimal(20, 8) @default(0) // Saldo bloqueado (saques pendentes)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tokenSymbol])
  @@index([userId])
  @@map("balances")
}

model GlobalWallet {
  id             String   @id @default(uuid())
  polygonAddress String   @unique
  privateKey     String // Criptografado
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  balances GlobalWalletBalance[]

  @@map("global_wallets")
}

model GlobalWalletBalance {
  id              String   @id @default(uuid())
  globalWalletId  String
  tokenSymbol     String // "USDC", "MATIC", "USDT", etc
  tokenAddress    String? // Contract address (null para MATIC)
  balance         Decimal  @db.Decimal(20, 8) // Saldo total da Global Wallet
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  globalWallet GlobalWallet @relation(fields: [globalWalletId], references: [id], onDelete: Cascade)

  @@unique([globalWalletId, tokenSymbol])
  @@index([globalWalletId])
  @@map("global_wallet_balances")
}

model Withdrawal {
  id                 String           @id @default(uuid())
  userId             String
  tokenSymbol        String
  tokenAddress       String?
  amount             Decimal          @db.Decimal(20, 8)
  destinationAddress String
  fee                Decimal          @db.Decimal(20, 8)
  status             WithdrawalStatus @default(PENDING_APPROVAL)
  txHash             String?          @unique
  approvedBy         String? // Admin userId
  approvedAt         DateTime?
  rejectedReason     String?
  processedAt        DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // ===== MLM v1.0 Fields =====

  // Fee Breakdown (taxas aplicadas)
  baseFee         Decimal @default(0) @db.Decimal(5, 2) // Taxa base por rank (8%-15%)
  progressiveFee  Decimal @default(0) @db.Decimal(5, 2) // Taxa progressiva (frequência)
  loyaltyDiscount Decimal @default(0) @db.Decimal(5, 2) // Desconto de lealdade (-2% a -6%)
  gasFee          Decimal @default(0) @db.Decimal(10, 8) // Gas fee da blockchain
  netAmount       Decimal @default(0) @db.Decimal(20, 8) // Valor líquido (amount - fee)

  // Tracking (snapshot no momento do saque)
  rank             MLMRank?     // Rank do usuário no momento do saque
  loyaltyTier      LoyaltyTier? // Loyalty tier no momento do saque
  withdrawalNumber Int? // Número do saque no mês (1º, 2º, 3º...)

  user          User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications WithdrawalNotification[]

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("withdrawals")
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String // "APPROVE_WITHDRAWAL", "BATCH_TRANSFER", etc
  entityId  String? // ID do withdrawal, user, etc
  details   Json? // Detalhes adicionais
  createdAt DateTime @default(now())

  @@map("admin_logs")
}

model WithdrawalNotification {
  id           String           @id @default(uuid())
  userId       String
  withdrawalId String
  type         NotificationType
  title        String // "Saque Aprovado!"
  message      String // "Seu saque de 500 USDC foi aprovado pelo administrador"
  data         Json? // Dados adicionais (txHash, motivo rejeição, etc)
  read         Boolean          @default(false)
  createdAt    DateTime         @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  withdrawal Withdrawal @relation(fields: [withdrawalId], references: [id], onDelete: Cascade)

  @@index([userId, read]) // Para query de notificações não lidas
  @@map("withdrawal_notifications")
}

// ===== MLM v1.0 Models =====

model Commission {
  id         String           @id @default(uuid())
  userId     String // Usuário que RECEBE a comissão
  fromUserId String // Usuário que GEROU a comissão (da rede)

  // Valores
  baseAmount  Decimal @db.Decimal(20, 8) // Saldo total do fromUser
  level       Int // 1 (N1), 2 (N2), 3 (N3)
  percentage  Decimal @db.Decimal(5, 2) // Ex: 1.05, 2.60
  finalAmount Decimal @db.Decimal(20, 8) // baseAmount × (percentage / 100)

  // Tracking
  referenceDate DateTime // Data do cálculo (ontem)
  paidAt        DateTime? // Data que foi creditada no balance
  status        CommissionStatus @default(PENDING)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, referenceDate])
  @@index([status])
  @@index([fromUserId])
  @@map("commissions")
}

model MonthlyStats {
  id     String @id @default(uuid())
  userId String

  // Período
  month Int // 1-12
  year  Int // 2025, 2026...

  // Métricas calculadas
  activeDirects   Int     @default(0) // Diretos ativos no mês
  totalVolume     Decimal @default(0) @db.Decimal(20, 2) // Volume da rede (N1+N2+N3)
  metRequirements Boolean @default(false) // Se cumpriu os requisitos

  // Snapshot
  rankAtStart MLMRank // Rank no início do mês

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId])
  @@index([year, month])
  @@map("monthly_stats")
}
