# PRD - Product Requirements Document
## MVP v2.0 - Transfer√™ncias, Saques e Administra√ß√£o

**Vers√£o:** 2.0
**Data:** 21 de Outubro de 2025
**Status:** Planejamento
**Autor:** Equipe de Desenvolvimento

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [O que foi entregue no v1.0](#o-que-foi-entregue-no-v10)
3. [Objetivos do v2.0](#objetivos-do-v20)
4. [Funcionalidades v2.0](#funcionalidades-v20)
5. [Fora do Escopo v2.0](#fora-do-escopo-v20)
6. [Especifica√ß√µes T√©cnicas](#especifica√ß√µes-t√©cnicas)

---

## üéØ Vis√£o Geral

O MVP v2.0 completa o ciclo financeiro do sistema, implementando transfer√™ncias em lote, sistema de saques, e ferramentas administrativas para gerenciar a plataforma.

### Problema a Resolver

Com o v1.0, usu√°rios podem:
- ‚úÖ Criar conta e fazer login
- ‚úÖ Receber endere√ßo de dep√≥sito
- ‚úÖ Fazer dep√≥sitos (qualquer token)
- ‚úÖ Ver saldo e transa√ß√µes

**Mas n√£o podem:**
- ‚ùå Sacar fundos
- ‚ùå Admins n√£o t√™m controle sobre transfer√™ncias
- ‚ùå Tokens ficam espalhados em m√∫ltiplos endere√ßos (alto custo de gas)

---

## ‚úÖ O que foi entregue no v1.0

### Funcionalidades Implementadas
1. **Autentica√ß√£o** - Better Auth (email/password)
2. **Sistema de Conta Virtual** - Status INACTIVE ‚Üí ACTIVE
3. **Ativa√ß√£o Autom√°tica** - Ap√≥s dep√≥sito >= $100 USD
4. **Endere√ßo Fixo Polygon** - 1 por usu√°rio, permanente
5. **Detec√ß√£o de Dep√≥sitos** - Webhook Moralis (qualquer token)
6. **Convers√£o de Pre√ßos** - CoinGecko API (tokens ‚Üí USD)
7. **Gest√£o de Saldo** - Multi-token, calculado em tempo real
8. **Hist√≥rico de Transa√ß√µes** - Completo por usu√°rio

### Banco de Dados v1.0
- ‚úÖ User (autentica√ß√£o + conta)
- ‚úÖ DepositAddress (1 por usu√°rio)
- ‚úÖ WalletTransaction (hist√≥rico)
- ‚úÖ GlobalWallet (criado mas n√£o usado)

### Status Atual
- Tokens ficam nos endere√ßos individuais dos usu√°rios
- Global Wallet existe mas n√£o recebe fundos
- Sistema preparado para pr√≥xima fase

---

## üéØ Objetivos do v2.0

### Objetivos de Neg√≥cio
1. Permitir que usu√°rios saquem seus fundos
2. Centralizar fundos na Global Wallet (reduzir custo de gas)
3. Dar aos admins controle sobre o fluxo financeiro
4. Preparar infraestrutura para MLM (fase 3)

### Objetivos T√©cnicos
1. ‚úÖ Implementar job/rota de transfer√™ncia em lote
2. ‚úÖ Implementar sistema completo de saques
3. ‚úÖ Criar painel administrativo b√°sico
4. ‚úÖ Otimizar custos de gas com batch transfers
5. ‚úÖ Adicionar rate limiting e seguran√ßa

---

## üì¶ Funcionalidades v2.0

### F1: Transfer√™ncia em Lote para Global Wallet

**Descri√ß√£o:** Rota administrativa que transfere todos os tokens de todos os endere√ßos de usu√°rios para a Global Wallet em uma √∫nica opera√ß√£o em lote.

**Crit√©rios de Aceita√ß√£o:**
- ‚úÖ Rota protegida por autentica√ß√£o de admin
- ‚úÖ Busca todos os endere√ßos com saldo > 0
- ‚úÖ **Fase 1:** Distribui MATIC da global para endere√ßos que precisam
- ‚úÖ **Fase 2:** Transfere todos os tokens ‚Üí global
- ‚úÖ **Fase 3:** Recupera MATIC que sobrou
- ‚úÖ Atualiza status das transa√ß√µes para `SENT_TO_GLOBAL`
- ‚úÖ Registra hash de cada transfer√™ncia
- ‚úÖ Tratamento robusto de erros (retry, logging)
- ‚úÖ Endpoint retorna relat√≥rio detalhado da opera√ß√£o

**Endpoints:**
```
POST /admin/transfers/batch-collect
Authorization: Bearer <admin-token>

Response:
{
  "success": true,
  "summary": {
    "totalAddresses": 25,
    "maticDistributed": "1.25",
    "tokensTransferred": {
      "USDC": "5000.00",
      "USDT": "2500.00",
      "MATIC": "500.00"
    },
    "maticRecovered": "0.85",
    "totalGasCost": "0.45 MATIC",
    "transactionsUpdated": 73
  },
  "details": [...],
  "errors": [...]
}
```

**Regras de Neg√≥cio:**
- Apenas admins podem executar
- Verifica se global wallet tem MATIC suficiente antes de iniciar
- Deixa ~0.01 MATIC de reserva em cada endere√ßo
- Se falhar em algum endere√ßo, continua com os pr√≥ximos
- Log completo de cada opera√ß√£o
- Pode ser executado manualmente ou via cron (futuro)

---

### F2: Sistema de Saques

**Descri√ß√£o:** Usu√°rios podem solicitar saque de seus fundos. Admin aprova e sistema processa automaticamente.

**Crit√©rios de Aceita√ß√£o:**
- ‚úÖ Usu√°rio pode solicitar saque (especificar token, valor, endere√ßo destino)
- ‚úÖ Valida√ß√µes: saldo suficiente, endere√ßo v√°lido, valor m√≠nimo
- ‚úÖ Saque fica com status `PENDING_APPROVAL`
- ‚úÖ Admin pode aprovar ou rejeitar
- ‚úÖ **Ap√≥s aprova√ß√£o, usu√°rio recebe notifica√ß√£o de autoriza√ß√£o**
- ‚úÖ Sistema transfere da Global Wallet ‚Üí endere√ßo do usu√°rio
- ‚úÖ **Usu√°rio recebe notifica√ß√£o de conclus√£o (com txHash)**
- ‚úÖ **Se rejeitado, usu√°rio recebe notifica√ß√£o com motivo**
- ‚úÖ Atualiza saldo do usu√°rio
- ‚úÖ Registra hash da transa√ß√£o

**Endpoints:**
```
# Usu√°rio solicita saque
POST /user/withdrawals/request
{
  "tokenSymbol": "USDC",
  "amount": "500.00",
  "destinationAddress": "0x..."
}

# Usu√°rio lista seus saques
GET /user/withdrawals

# Usu√°rio consulta notifica√ß√µes de saque
GET /user/withdrawals/:id/status

# Admin lista todos os saques pendentes
GET /admin/withdrawals?status=PENDING_APPROVAL

# Admin aprova saque (envia notifica√ß√£o ao usu√°rio)
POST /admin/withdrawals/:id/approve
Response:
{
  "success": true,
  "withdrawal": {...},
  "notificationSent": true,
  "message": "Withdrawal approved and user notified"
}

# Admin rejeita saque (envia notifica√ß√£o ao usu√°rio)
POST /admin/withdrawals/:id/reject
{
  "reason": "Saldo insuficiente"
}
Response:
{
  "success": true,
  "withdrawal": {...},
  "notificationSent": true,
  "message": "Withdrawal rejected and user notified"
}
```

**Regras de Neg√≥cio:**
- **Saque m√≠nimo: $500 USD**
- Taxa de saque: configur√°vel (ex: $5 fixo ou 1%)
- Verifica se global wallet tem saldo suficiente
- Apenas 1 saque pendente por vez por usu√°rio
- Ap√≥s aprova√ß√£o, processamento autom√°tico
- Se processamento falhar, volta para `PENDING_APPROVAL`
- Usu√°rio n√£o pode cancelar ap√≥s aprova√ß√£o

---

### F3: Dashboard Administrativo

**Descri√ß√£o:** Painel web simples para admins gerenciarem a plataforma.

**Crit√©rios de Aceita√ß√£o:**
- ‚úÖ Login de admin separado (role-based)
- ‚úÖ Estat√≠sticas gerais (total usu√°rios, dep√≥sitos, saques)
- ‚úÖ Lista de usu√°rios (com filtros e busca)
- ‚úÖ Detalhes de cada usu√°rio (saldo, transa√ß√µes, status)
- ‚úÖ Gest√£o de saques (aprovar/rejeitar)
- ‚úÖ Executar batch transfer
- ‚úÖ Ver saldo da Global Wallet
- ‚úÖ Logs de opera√ß√µes cr√≠ticas

**Endpoints:**
```
# Estat√≠sticas
GET /admin/stats

# Usu√°rios
GET /admin/users?page=1&limit=20&search=email

# Detalhes de usu√°rio
GET /admin/users/:id

# Bloquear/desbloquear usu√°rio
POST /admin/users/:id/block
POST /admin/users/:id/unblock

# Global Wallet
GET /admin/wallet/balance
GET /admin/wallet/transactions

# Logs
GET /admin/logs?type=TRANSFER&date=2025-10-21
```

**Regras de Neg√≥cio:**
- Apenas usu√°rios com `role: ADMIN` podem acessar
- Logs de todas as a√ß√µes de admin
- N√£o pode deletar usu√°rios (apenas bloquear)
- Dashboard pode ser React/Next.js (frontend separado) ou server-side rendered

---

### F4: Otimiza√ß√µes e Seguran√ßa

**Descri√ß√£o:** Melhorias de performance, seguran√ßa e monitoramento.

**Crit√©rios de Aceita√ß√£o:**

**Rate Limiting:**
- ‚úÖ 100 req/15min por IP em rotas p√∫blicas
- ‚úÖ 1000 req/15min em rotas autenticadas
- ‚úÖ 10 req/min em rotas de saque/transfer√™ncia

**Valida√ß√µes:**
- ‚úÖ Endere√ßo Polygon v√°lido (checksum)
- ‚úÖ Valor num√©rico positivo
- ‚úÖ Token suportado

**Monitoramento:**
- ‚úÖ Log estruturado (Pino/Winston)
- ‚úÖ M√©tricas de lat√™ncia
- ‚úÖ Alertas para erros cr√≠ticos
- ‚úÖ Health check endpoint

**Backup:**
- ‚úÖ Backup autom√°tico do banco
- ‚úÖ Backup das private keys (encrypted)

---

## ‚ùå Fora do Escopo v2.0

### Funcionalidades para v3.0+
- ‚ùå Sistema MLM (comiss√µes, indica√ß√µes, √°rvore geneal√≥gica)
- ‚ùå Notifica√ß√µes push/email
- ‚ùå Suporte a m√∫ltiplas blockchains
- ‚ùå Exchange interno (swap de tokens)
- ‚ùå Staking/Rendimentos
- ‚ùå App mobile (React Native)

---

## üîß Especifica√ß√µes T√©cnicas

### Novos Models Prisma

```prisma
enum WithdrawalStatus {
  PENDING_APPROVAL
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
}

model Withdrawal {
  id                  String           @id @default(uuid())
  userId              String
  tokenSymbol         String
  tokenAddress        String?
  amount              Decimal          @db.Decimal(20, 8)
  destinationAddress  String
  fee                 Decimal          @db.Decimal(20, 8)
  status              WithdrawalStatus @default(PENDING_APPROVAL)
  txHash              String?          @unique
  approvedBy          String?          // Admin userId
  approvedAt          DateTime?
  rejectedReason      String?
  processedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("withdrawals")
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String   // "APPROVE_WITHDRAWAL", "BATCH_TRANSFER", etc
  entityId  String?  // ID do withdrawal, user, etc
  details   Json?    // Detalhes adicionais
  createdAt DateTime @default(now())

  @@map("admin_logs")
}

enum NotificationType {
  WITHDRAWAL_APPROVED
  WITHDRAWAL_REJECTED
  WITHDRAWAL_COMPLETED
  WITHDRAWAL_FAILED
}

model WithdrawalNotification {
  id           String           @id @default(uuid())
  userId       String
  withdrawalId String
  type         NotificationType
  title        String           // "Saque Aprovado!"
  message      String           // "Seu saque de 500 USDC foi aprovado pelo administrador"
  data         Json?            // Dados adicionais (txHash, motivo rejei√ß√£o, etc)
  read         Boolean          @default(false)
  createdAt    DateTime         @default(now())

  user       User       @relation(fields: [userId], references: [id])
  withdrawal Withdrawal @relation(fields: [withdrawalId], references: [id])

  @@index([userId, read]) // Para query de notifica√ß√µes n√£o lidas
  @@map("withdrawal_notifications")
}

// Adicionar ao User model:
model User {
  // ... campos existentes ...
  role      String   @default("user") // "user" ou "admin" (Better Auth j√° suporta)

  withdrawals              Withdrawal[]
  withdrawalNotifications  WithdrawalNotification[]
}

// Adicionar ao Withdrawal model:
model Withdrawal {
  // ... campos existentes ...
  notifications WithdrawalNotification[]
}
```

### Vari√°veis de Ambiente Adicionais

```env
# Saque
WITHDRAWAL_MIN_USD=500
WITHDRAWAL_FEE_USD=5
WITHDRAWAL_FEE_PERCENT=1

# Admin
ADMIN_JWT_SECRET="different-from-user-jwt"

# Rate Limiting
RATE_LIMIT_PUBLIC=100
RATE_LIMIT_AUTHENTICATED=1000
RATE_LIMIT_CRITICAL=10

# Monitoring
SENTRY_DSN="https://..."
LOG_LEVEL=info
```

### Endpoints de Notifica√ß√£o

```
# Usu√°rio lista suas notifica√ß√µes
GET /user/notifications
Response:
{
  "notifications": [
    {
      "id": "uuid",
      "type": "WITHDRAWAL_APPROVED",
      "title": "Saque Aprovado!",
      "message": "Seu saque de 500 USDC foi aprovado",
      "data": { "withdrawalId": "uuid", "amount": "500" },
      "read": false,
      "createdAt": "2025-10-21T10:00:00Z"
    }
  ],
  "unreadCount": 3
}

# Marcar notifica√ß√£o como lida
PATCH /user/notifications/:id/read

# Marcar todas como lidas
PATCH /user/notifications/read-all
```

### Estrutura de M√≥dulos

```
src/modules/
‚îú‚îÄ admin/
‚îÇ  ‚îú‚îÄ controllers/
‚îÇ  ‚îÇ  ‚îú‚îÄ get-stats-controller.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ list-users-controller.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ get-user-details-controller.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ block-user-controller.ts
‚îÇ  ‚îú‚îÄ use-cases/
‚îÇ  ‚îÇ  ‚îú‚îÄ get-platform-stats.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ manage-user-status.ts
‚îÇ  ‚îî‚îÄ routes.ts
‚îÇ
‚îú‚îÄ transfer/
‚îÇ  ‚îú‚îÄ controllers/
‚îÇ  ‚îÇ  ‚îî‚îÄ batch-collect-controller.ts
‚îÇ  ‚îú‚îÄ use-cases/
‚îÇ  ‚îÇ  ‚îî‚îÄ batch-collect-to-global.ts
‚îÇ  ‚îî‚îÄ routes.ts
‚îÇ
‚îú‚îÄ withdrawal/
‚îÇ  ‚îú‚îÄ controllers/
‚îÇ  ‚îÇ  ‚îú‚îÄ request-withdrawal-controller.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ list-withdrawals-controller.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ approve-withdrawal-controller.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ reject-withdrawal-controller.ts
‚îÇ  ‚îú‚îÄ use-cases/
‚îÇ  ‚îÇ  ‚îú‚îÄ request-withdrawal.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ approve-withdrawal.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ process-withdrawal.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ reject-withdrawal.ts
‚îÇ  ‚îú‚îÄ services/
‚îÇ  ‚îÇ  ‚îî‚îÄ notification.service.ts  // Envia notifica√ß√µes
‚îÇ  ‚îî‚îÄ routes.ts
‚îÇ
‚îú‚îÄ notification/
‚îÇ  ‚îú‚îÄ controllers/
‚îÇ  ‚îÇ  ‚îú‚îÄ list-notifications-controller.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ mark-as-read-controller.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ mark-all-read-controller.ts
‚îÇ  ‚îú‚îÄ use-cases/
‚îÇ  ‚îÇ  ‚îú‚îÄ create-notification.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ get-user-notifications.ts
‚îÇ  ‚îî‚îÄ routes.ts
‚îÇ
‚îî‚îÄ wallet/
   ‚îú‚îÄ controllers/
   ‚îÇ  ‚îî‚îÄ get-global-balance-controller.ts
   ‚îú‚îÄ use-cases/
   ‚îÇ  ‚îú‚îÄ get-global-wallet-balance.ts
   ‚îÇ  ‚îî‚îÄ decrypt-private-key.ts
   ‚îî‚îÄ routes.ts
```

---

## üìä M√©tricas de Sucesso

### M√©tricas de Produto
- ‚úÖ 95% dos saques processados em < 10 minutos
- ‚úÖ 100% dos batch transfers bem-sucedidos
- ‚úÖ Redu√ß√£o de 80% no custo de gas vs transfer√™ncias individuais
- ‚úÖ 0 saques perdidos ou duplicados

### M√©tricas T√©cnicas
- ‚úÖ Admin dashboard load time < 2s
- ‚úÖ Withdrawal approval API < 500ms
- ‚úÖ Batch transfer completa em < 5min para 100 endere√ßos
- ‚úÖ 99.9% uptime

### M√©tricas de Seguran√ßa
- ‚úÖ 0 private keys expostas
- ‚úÖ 100% das a√ß√µes de admin logadas
- ‚úÖ Rate limiting efetivo (0 ataques bem-sucedidos)

---

## üö® Riscos e Mitiga√ß√µes

### Risco 1: Global Wallet Comprometida
**Impacto:** Cr√≠tico
**Probabilidade:** Baixa
**Mitiga√ß√£o:**
- Multi-sig wallet (fase futura)
- Monitoramento 24/7
- Limites di√°rios de saque
- Cold wallet para fundos maiores

### Risco 2: Falha no Batch Transfer
**Impacto:** Alto
**Probabilidade:** M√©dia
**Mitiga√ß√£o:**
- Retry autom√°tico (3 tentativas)
- Continuar mesmo se alguns falharem
- Alertas imediatos
- Rollback se > 50% falhar

### Risco 3: Saque Processado Duas Vezes
**Impacto:** Alto (perda financeira)
**Probabilidade:** Baixa
**Mitiga√ß√£o (Defense in Depth):**

**Camada 0: Aprova√ß√£o Manual por Admin (Linha de Frente)**
```typescript
// NENHUM saque √© processado automaticamente
// Fluxo obrigat√≥rio:
// 1. Usu√°rio solicita ‚Üí status: PENDING_APPROVAL
// 2. Admin revisa manualmente
// 3. Admin aprova ‚Üí status: APPROVED
// 4. Sistema processa ‚Üí status: PROCESSING ‚Üí COMPLETED

// Vantagens:
// - Humano verifica cada saque antes de processar
// - Admin pode validar: endere√ßo, valor, usu√°rio, hist√≥rico
// - Previne fraudes e erros
// - Admin v√™ se j√° foi processado antes de aprovar
```

**Camada 1: Lock Pessimista no Banco**
```typescript
// Usa SELECT FOR UPDATE para lock da linha
const withdrawal = await prisma.$transaction(async (tx) => {
  const w = await tx.withdrawal.findUnique({
    where: { id: withdrawalId },
    // Lock pessimista - impede leitura concorrente
  });

  // Verifica status - deve estar APPROVED
  if (w.status !== 'APPROVED') {
    throw new Error('Invalid status for processing');
  }

  // Atualiza para PROCESSING atomicamente
  return tx.withdrawal.update({
    where: { id: withdrawalId },
    data: {
      status: 'PROCESSING',
      processedAt: new Date()
    }
  });
}, {
  isolationLevel: 'Serializable' // M√°ximo n√≠vel de isolamento
});
```

**Camada 2: Status Intermedi√°rio**
- `APPROVED` ‚Üí `PROCESSING` ‚Üí `COMPLETED`
- Apenas saques com status `APPROVED` podem ser processados
- `PROCESSING` impede reprocessamento

**Camada 3: Verifica√ß√£o de txHash**
```typescript
// Antes de processar, verifica se j√° existe txHash
if (withdrawal.txHash) {
  throw new Error('Withdrawal already has txHash - already processed');
}

// Ap√≥s enviar transa√ß√£o blockchain
await prisma.withdrawal.update({
  where: { id: withdrawalId },
  data: {
    txHash: txHash,
    status: 'COMPLETED'
  }
});
```

**Camada 4: Idempotency Key**
```typescript
// Gera chave √∫nica para cada tentativa de processamento
const idempotencyKey = `withdrawal-${withdrawalId}-${Date.now()}`;

// Armazena em cache (Redis) por 24h
await redis.setex(idempotencyKey, 86400, 'processing');

// Se j√° existe, rejeita
if (await redis.exists(idempotencyKey)) {
  throw new Error('Duplicate processing attempt');
}
```

**Camada 5: Unique Constraint no Banco**
```prisma
model Withdrawal {
  // ...
  txHash String? @unique // Garante que n√£o pode ter 2 saques com mesmo txHash
}
```

**Camada 6: Rate Limiting por Usu√°rio**
```typescript
// M√°ximo 1 saque em processamento por usu√°rio
const processing = await prisma.withdrawal.count({
  where: {
    userId: withdrawal.userId,
    status: 'PROCESSING'
  }
});

if (processing > 0) {
  throw new Error('User already has withdrawal being processed');
}
```

**Camada 7: Auditoria e Alertas**
```typescript
// Log toda tentativa de processamento
await prisma.adminLog.create({
  data: {
    adminId: adminId,
    action: 'PROCESS_WITHDRAWAL',
    entityId: withdrawalId,
    details: {
      status: withdrawal.status,
      amount: withdrawal.amount,
      timestamp: new Date()
    }
  }
});

// Alerta se detectar tentativa duplicada
if (isDuplicate) {
  await sendAlert({
    type: 'CRITICAL',
    message: `Duplicate withdrawal processing attempt: ${withdrawalId}`,
    admin: adminId
  });
}
```

---


---

## üìö Refer√™ncias

- [PRD v1.0](./PRD-MVP-v1.md)
- [Ethers.js Batch Transactions](https://docs.ethers.org/v6/api/providers/#Provider-sendTransaction)
- [Polygon Gas Optimization](https://docs.polygon.technology/docs/develop/network-details/gas-token/)

---

**√öltima atualiza√ß√£o:** 21/10/2025
**Pr√≥xima revis√£o:** Ap√≥s conclus√£o do v2.0
